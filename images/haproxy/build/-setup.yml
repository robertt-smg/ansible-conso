---
- name: Update apt packages
  apt:
    update_cache: yes

- name: Upgrade all packages
  apt:
    upgrade: dist
    force_apt_get: yes

- name: Install apt-utils
  apt:
    name: apt-utils
    state: present
    install_recommends: no

- name: Install required packages
  apt:
    name:
      - inetutils-ping
      - rsyslog
      - iproute2
      - socat
      - git
      - curl
      - unzip
      - make
    state: present

- name: Create rsyslog.d directory
  file:
    path: /etc/rsyslog.d/
    state: directory

- name: Copy rsyslog.conf
  copy:
    src: "{{ BASEDIR }}/files/rsyslog.conf"
    dest: /etc/rsyslog.conf

- name: Create necessary directories
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - /usr/local/etc/haproxy
    - /var/log/rsyslogd
    - /usr/local/http
    - /var/log/haproxy

- name: Set permissions for log directories
  file:
    path: "{{ item }}"
    mode: "u+rw,g+rw"
  loop:
    - /var/log/haproxy
    - /var/log/rsyslogd

- name: Clone haproxy-lua-oauth repository
  git:
    repo: https://github.com/haproxytech/haproxy-lua-oauth.git
    dest: /tmp/haproxy-lua-oauth

- name: Run luaoauth installation script
  command: bash ./install.sh luaoauth
  args:
    chdir: /tmp/haproxy-lua-oauth

- name: Copy entrypoint script
  copy:
    src: "{{ BASEDIR }}/files/entrypoint.sh"
    dest: /usr/local/bin/entrypoint
    mode: "0755"

- name: Copy welcome HTTP file
  copy:
    src: "{{ BASEDIR }}/files/200welcome.http"
    dest: /usr/local/http/200welcome.http

- name: Copy haproxy.cfg
  copy:
    src: "{{ BASEDIR }}/files/haproxy.cfg"
    dest: /usr/local/etc/haproxy/haproxy.cfg


- name: Clean up apt cache and temporary files
  command: apt-get clean
- name: Remove temporary files
  command: rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
