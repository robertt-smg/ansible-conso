- hosts: Linux
  become: true
  gather_facts: no

  handlers:
  - import_tasks: handlers/handlers.yml

#  roles:
#    - geerlingguy.security
#    - geerlingguy.firewall

  pre_tasks:
  - name: Install Python
    raw: |
      apt-get update
      apt-get install -y python3 python3-pymysql python3-pip python3-cryptography # For Debian/Ubuntu

  - name: Update apt cache if needed.
    apt: update_cache=yes cache_valid_time=3600

  - name: Gather facts
    setup:

  - name: Install ansible group
    include_role:
      name: arillso.system.groups

  - name: Install ansible user
    include_role:
      name: arillso.system.users

  - name: Create ansible sudoers file
    copy:
      content: "ansible ALL=(ALL) NOPASSWD:ALL"
      dest: /etc/sudoers.d/ansible
      mode: '0440'
      owner: root
      group: root
      validate: /usr/sbin/visudo -cf %s      

  tasks:
  - name: Backup /etc/default/grub
    copy:
      src: /etc/default/grub
      dest: /etc/default/grub.bak
      remote_src: yes

  - name: Update GRUB_CMDLINE_LINUX in /etc/default/grub
    lineinfile:
      path: /etc/default/grub
      regexp: '^GRUB_CMDLINE_LINUX='
      line: 'GRUB_CMDLINE_LINUX="ipv6.disable=1"'
      backrefs: yes

  - name: Run update-grub
    command: update-grub

  - name: Backup /etc/modprobe.d/blacklist.conf
    copy:
      src: /etc/modprobe.d/blacklist.conf
      dest: /etc/modprobe.d/blacklist.conf.bak
      remote_src: yes

  - name: Add blacklist ipv6 to /etc/modprobe.d/blacklist.conf
    lineinfile:
      path: /etc/modprobe.d/blacklist.conf
      line: 'blacklist ipv6'
      create: yes
      state: present
      
  - name: install geerlingguy.security
    include_role:
      name: geerlingguy.security
  - name: install geerlingguy.firewall
    include_role:
      name: geerlingguy.firewall

  - name: Trigger reboot without waiting
    shell: "sleep 2 && reboot"
    async: 1
    poll: 0
    ignore_errors: true

  - name: End play after reboot triggered
    meta: end_play