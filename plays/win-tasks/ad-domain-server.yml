---
# Ansible tasks to manage a new domain, add servers, groups, and users (idempotent)
# Uses microsoft.ad collection

- name: Join servers to domain (run on each server)
  microsoft.ad.membership:
    dns_domain_name: "{{ ad_domain_name | default('example') }}.{{ ad_domain_suffix | default('local') }}"
    domain_admin_user: "{{ ad_domain_admin_user }}"
    domain_admin_password: "{{ ad_domain_admin_password }}"
    domain_server: "{{ ad_domain_server }}"
    hostname: "{{ item }}"
    state: domain
    reboot: true

  loop: "{{ ad_servers_list | default([]) }}"
  when: ad_servers_list is defined and ad_servers_list | length > 0

# Optionally, you can add a task to verify users, groups, and computers exist as expected
