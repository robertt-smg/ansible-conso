---
# Ansible tasks to manage a new domain, add servers, groups, and users (idempotent)
# Uses microsoft.ad collection

- name: Check if domain exists
  microsoft.ad.object_info:
    identity: "DC={{ ad_domain_name | default('example') }},DC={{ ad_domain_suffix | default('local') }}"
    domain_username: "{{ ad_domain_admin_user }}"
    domain_password: "{{ ad_domain_admin_password }}"
    domain_server: "{{ ad_domain_server }}"
  register: ad_domain_info
  ignore_errors: true

- name: Create domain if not exists
  microsoft.ad.domain:
    dns_domain_name: "{{ ad_domain_name | default('example') }}.{{ ad_domain_suffix | default('local') }}"
    safe_mode_password: "{{ ad_domain_safe_mode_password }}"
  when: ad_domain_info.objects is not defined or ad_domain_info.objects | length == 0
  register: ad_domain_create

- name: Reboot if domain created
  ansible.windows.win_reboot:
  when: ad_domain_create is defined and ad_domain_create.reboot_required is defined and ad_domain_create.reboot_required

- name: Wait for system to become reachable again ...
  wait_for_connection:
      timeout: 900

# Gather all unique groups from winusers_list_default
- name: Gather all unique groups from winusers_list
  delegate_to: dserver1_dc
  set_fact:
    ad_all_groups: "{{ winusers_list | dict2items | map(attribute='value.groups') | select('defined') | sum(start=[]) | unique }}"

- name: Ensure all groups exist in AD
  microsoft.ad.group:
    name: "{{ item }}"
    scope: domainlocal
    state: present
  loop: "{{ ad_all_groups }}"
  register: ad_group_result
  failed_when: >
    ad_group_result.failed and
    'The specified local group already exists' not in (ad_group_result.msg | default('')) and
    'The specified local group already exists' not in (ad_group_result.msg | default('')) and
    'Cannot perform this operation on built-in accounts' not in (ad_group_result.msg | default('')) and
    'The request is not supported' not in (ad_group_result.msg | default(''))

- name: "DEBUG: Show password for user creation"
  debug:
    msg: "User: {{ item.key }}, Password: {{ item.value.password | default('omit') }}"
  loop: "{{ winusers_list | dict2items }}"

- name: Ensure users exist and are configured
  microsoft.ad.user:
    identity: "{{ item.key }}"
    password: "{{ item.value.password | default(omit) }}"
    password_never_expires: "{{ item.value.password_never_expires | default(false) }}"
    update_password: "{{ item.value.update_password | default('on_create') }}"
    enabled: true
    groups:
      add: "{{ item.value.groups | default([]) }}"
    state: present
  loop: "{{ winusers_list | dict2items }}"

- name: Ensure computer objects exist in AD
  microsoft.ad.computer:
    name: "{{ item }}"
    state: present
  register: ad_computer_result
  failed_when: >
    ad_computer_result.failed and
    'The specified account already exists' not in (ad_computer_result.msg | default(''))
  loop: "{{ ad_servers_list_register | default([]) }}"

