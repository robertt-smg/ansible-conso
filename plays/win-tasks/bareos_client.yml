
- name: Copy bareos-client Setup
  win_copy:
    src: files/winbareos-24.0.4~pre21.6a9d93652-release-64-bit.exe
    dest: c:\\windows\\temp\\winbareos-24.0.4~pre21.6a9d93652-release-64-bit.exe

- name: Install bareos-client Setup
  ansible.windows.win_package:
    path: c:\windows\temp\winbareos-24.0.4~pre21.6a9d93652-release-64-bit.exe
    log_path: c:\windows\temp\winbareos.log
    arguments: /S /silentkeepconfig
    # Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall
    product_id: 'Bareos'  # Replace with actual product ID from the MSI
  register: install_result_winbareos
  ignore_errors: true

- name: Verify Install bareos-client Setup
  debug:
    msg: "Installation failed: {{ install_result_winbareos }}"
  when: install_result_winbareos is failed

- name: Add ExclusionProcess to Windows Defender exclusion list for bareos
  win_shell: powershell.exe -ExecutionPolicy ByPass -Command "Add-MpPreference -ExclusionProcess 'C:\Program Files\Bareos\bareos-fd.exe' -Force"
  ignore_errors: yes

- name: Add ExclusionPath to Windows Defender exclusion list for bareos
  win_shell: powershell.exe -ExecutionPolicy ByPass -Command "Add-MpPreference -ExclusionPath 'C:\Program Files\Bareos' -Force"
  ignore_errors: yes  