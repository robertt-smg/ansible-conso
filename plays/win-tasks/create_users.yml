- name: Ensure users are present
  ansible.windows.win_user:
    name: "{{ item.key }}"
    password: "{{ item.value.password }}"
    state: "{{item.value.state|default('present')}}" 
    account_expires: never
    groups: "{{ item.value.groups | default([]) }}"
    groups_action: add

    password_never_expires: "{{ item.value.password_never_expires | default(false) }}"
    update_password: "{{ item.value.update_password | default(on_create)}}"

  loop: "{{ winusers_list | dict2items }}"
  # Only create user if enabled is true
  when: item.value.enabled | default(false)
