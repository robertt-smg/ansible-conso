- name: Include tasks setup powershell
  include_tasks: win-tasks/ps_setup.yml

- name: Include update Timezone
  include_tasks: win-tasks/timezone.yml

- name: Include update Locale Settings
  include_tasks: win-tasks/locale.yml

- name: Include windows user create task if winusers_list is defined
  include_tasks: win-tasks/create_users.yml
  when: winusers_list is defined and winusers_list

- name: Include choco app install task if chocoapps_list is defined
  include_tasks: win-tasks/choco.yml
  when: chocoapps_list is defined and chocoapps_list

- name: Enable server roles
  include_tasks: win-tasks/roles.yml
  when: winserver_roles_enabled is defined

- name: Check if CloudSOE hardening has already been applied
  win_stat:
    path: C:\cloudSOE_hardening.done
  register: cloudsoe_hardening_done

- name: Include tasks for ISM hardening based on CloudSOE project
  include_tasks: win-tasks/cloudsoe_hardening.yml
  when: not cloudsoe_hardening_done.stat.exists

- name: Create CloudSOE hardening completion marker file
  win_file:
    path: C:\cloudSOE_hardening.done
    state: touch
  when: not cloudsoe_hardening_done.stat.exists

- name: Include update Local Group Policies
  include_tasks: win-tasks/policy_settings_ps.yml

#- name: Install icinga2 client on windows
#  include_tasks: win-tasks/icinga2.yml

- name: Configure Defender
  include_tasks: win-tasks/defender.yml
  when: defender_list is defined and defender_list

- name: Configure airQuest
  include_tasks: win-tasks/airquest.yml
  when: airquest_defaults.enabled is defined and airquest_defaults.enabled

- name: install proQuest
  include_tasks: win-tasks/proquest.yml
  when: airquest_defaults.enabled is defined and airquest_defaults.enabled

- name: Enable printspooler for airQuest
  include_tasks: win-tasks/printspooler.yml
  when: airquest_defaults.enabled is defined and airquest_defaults.enabled  

- name: Install FoxPro for airQuest
  include_tasks: win-tasks/foxpro.yml
  when: airquest_defaults.enabled is defined and airquest_defaults.enabled  

- name: Install Advantage OLDEDB for FoxPro
  include_tasks: win-tasks/advantage_oledb.yml
  when: airquest_defaults.advantage_oldedb is defined and airquest_defaults.advantage_oldedb  

- name: Install FreeOpener
  include_tasks: win-tasks/freeopener.yml
  when: airquest_defaults.enabled is defined and airquest_defaults.enabled
  
- name: Ensure destination directory for wallpaper exists
  win_file:
    path: C:\users\public
    state: directory

- name: Copy Background image to wallpaper
  win_copy:
    src: files/{{ airquest_defaults.wallpaper.name }}
    dest: C:\\users\\public\\wallpaper.jpg
  when: airquest_defaults.wallpaper.enabled is defined and airquest_defaults.wallpaper.enabled

- name: Install bareos client
  include_tasks: win-tasks/bareos_client.yml
  when: extra_apps_list is defined and extra_apps_list.bareos_client is defined and extra_apps_list.bareos_client.enabled is defined and extra_apps_list.bareos_client.enabled

- name: Install airQuest Terminal Server Startup Script
  include_tasks: win-tasks/airQuestTS.yml
  when: airquest_defaults.airQuestTS is defined and airquest_defaults.airQuestTS

- name: Install RemoteApp Tool
  include_tasks: win-tasks/remoteApp.yml
  when: airquest_defaults.airQuestTS is defined and airquest_defaults.airQuestTS
